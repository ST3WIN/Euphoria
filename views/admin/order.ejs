<%- include("../partials/admin/header.ejs") %>

<div class="container-fluid py-4">
    <div class="row">
        <main class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 80px">Image</th>
                                    <th>Product</th>
                                    <th>Customer</th>
                                    <th class="text-center">Quantity</th>
                                    <th class="text-end">Price</th>
                                    <th>Status</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% orders.forEach(order => { %>
                                    <% order.orderItems.forEach(item => { %>
                                        <tr>
                                            <td>
                                                <% if (item.product && item.product.productImage && item.product.productImage.length > 0) { %>
                                                    <img src="/uploads/product-images/<%= item.product.productImage[0] %>" 
                                                         alt="<%= item.product.productName %>" 
                                                         class="img-thumbnail"
                                                         style="width: 60px; height: 60px; object-fit: cover;">
                                                <% } else { %>
                                                    <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                                         style="width: 60px; height: 60px;">
                                                        <i class="bi bi-image text-muted"></i>
                                                    </div>
                                                <% } %>
                                            </td>
                                            <td>
                                                <div class="fw-medium">
                                                    <%= item.product ? item.product.productName : 'Product Unavailable' %>
                                                </div>
                                                <% if (item.product && item.product.brand) { %>
                                                    <small class="text-muted"><%= item.product.brand %></small>
                                                <% } %>
                                            </td>
                                            <td>
                                                <div class="fw-medium">
                                                    <% if (order.address) { %>
                                                        <%= order.address.firstName %> <%= order.address.lastName || '' %>
                                                    <% } else { %>
                                                        N/A
                                                    <% } %>
                                                </div>
                                                <% if (order.address && order.address.phone) { %>
                                                    <small class="text-muted"><%= order.address.phone %></small>
                                                <% } %>
                                            </td>
                                            <td class="text-center"><%= item.quantity %></td>
                                            <td class="text-end">â‚¹<%= item.price ? item.price.toLocaleString() : '0' %></td>
                                            <td>
                                                <select class="form-select form-select-sm" 
                                                        onchange="updateOrderStatus(this, '<%= order._id %>')"
                                                        <%= order.status === 'Cancelled' ? 'disabled' : '' %>>
                                                    <option value="Pending" <%= order.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                                                    <option value="Processing" <%= order.status === 'Processing' ? 'selected' : '' %>>Processing</option>
                                                    <option value="Shipped" <%= order.status === 'Shipped' ? 'selected' : '' %>>Shipped</option>
                                                    <option value="Delivered" <%= order.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                                                </select>
                                            </td>
                                            <td>
                                                <% if (order.status === 'Cancelled') { %>
                                                    <button class="btn btn-sm btn-secondary" disabled>
                                                        Cancelled
                                                    </button>
                                                <% } else { %>
                                                    <button class="btn btn-sm btn-danger" 
                                                            onclick="cancelOrder('<%= order._id %>')"
                                                            <%= order.status === 'Delivered' ? 'disabled' : '' %>>
                                                        Cancel
                                                    </button>
                                                <% } %>
                                            </td>
                                        </tr>
                                    <% }); %>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>

<script>
    async function updateOrderStatus(selectElement, orderId) {
        try {
            const status = selectElement.value;
            const response = await fetch('/admin/orders/updateStatus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ orderId, status })
            });

            const result = await response.json();
            if (result.success) {
                await Swal.fire({
                    title: 'Success!',
                    text: 'Order status updated successfully',
                    icon: 'success',
                    confirmButtonColor: '#3085d6'
                });

                // Disable cancel button if order is delivered
                if (status === 'Delivered') {
                    const cancelBtn = selectElement.closest('tr').querySelector('.btn-danger');
                    if (cancelBtn) cancelBtn.disabled = true;
                }
            } else {
                await Swal.fire({
                    title: 'Error!',
                    text: result.error || 'Failed to update order status',
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
            await Swal.fire({
                title: 'Error!',
                text: 'An error occurred while updating order status',
                icon: 'error',
                confirmButtonColor: '#d33'
            });
            location.reload();
        }
    }

    async function cancelOrder(orderId) {
        const result = await Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, cancel it!'
        });

        if (result.isConfirmed) {
            try {
                const response = await fetch('/admin/orders/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ orderId })
                });

                const result = await response.json();
                if (result.success) {
                    await Swal.fire({
                        title: 'Cancelled!',
                        text: 'Order has been cancelled.',
                        icon: 'success',
                        confirmButtonColor: '#3085d6'
                    });

                    // Update UI without reloading
                    const row = document.querySelector(`button[onclick="cancelOrder('${orderId}')"]`).closest('tr');
                    const statusSelect = row.querySelector('select');
                    const cancelBtn = row.querySelector('.btn-danger');
                    
                    // Update status to Cancelled
                    statusSelect.value = 'Cancelled';
                    statusSelect.disabled = true;
                    
                    // Replace cancel button with Cancelled button
                    const newButton = document.createElement('button');
                    newButton.className = 'btn btn-sm btn-secondary';
                    newButton.disabled = true;
                    newButton.textContent = 'Cancelled';
                    cancelBtn.parentNode.replaceChild(newButton, cancelBtn);
                } else {
                    await Swal.fire({
                        title: 'Error!',
                        text: result.error || 'Failed to cancel order',
                        icon: 'error',
                        confirmButtonColor: '#d33'
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                await Swal.fire({
                    title: 'Error!',
                    text: 'An error occurred while cancelling the order',
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });
            }
        }
    }
</script>

<%- include("../partials/admin/footer.ejs") %>