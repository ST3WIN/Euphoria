<%- include("../partials/admin/header.ejs") %>
        <section class="content-main">
            <div class="content-header">
                <div class="d-flex justify-content-between">
                    <h2 class="content-title card-title">Sales Report</h2>
                    <div>
                        <a href="/admin/download-sales-report/pdf" class="btn btn-primary pr-3" target="_blank">
                            <i class="material-icons md-file_download"></i> Download PDF
                        </a>
                        <a href="/admin/download-sales-report/excel" class="btn btn-success" target="_blank">
                            <i class="material-icons md-file_download"></i> Download Excel
                        </a>
                    </div>
                </div>
            </div>

            <div class="row">
                <% 
                let totalOrders = 0;
                let totalPrice = 0;
                let totalDiscount = 0;
                
                if (orders && orders.length > 0) {
                    totalOrders = orders.length;
                    orders.forEach(order => {
                        order.orderItems.forEach(item => {
                            totalPrice += (item.price * item.quantity);
                        });
                        totalDiscount += (order.discount || 0);
                    });
                }
                
                const netProfit = totalPrice - totalDiscount;

                function formatIndianCurrency(number) {
                    return new Intl.NumberFormat('en-IN', {
                        style: 'currency',
                        currency: 'INR',
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }).format(number);
                }
                %>

                <div class="col-lg-3">
                    <div class="card card-body mb-4">
                        <article class="icontext">
                            <span class="icon icon-sm rounded-circle bg-primary-light">
                                <i class="text-primary material-icons md-monetization_on"></i>
                            </span>
                            <div class="text">
                                <h6 class="mb-1 card-title">Total Sales</h6>
                                <span><%= totalOrders %> Orders</span>
                            </div>
                        </article>
                    </div>
                </div>

                <div class="col-lg-3">
                    <div class="card card-body mb-4">
                        <article class="icontext">
                            <span class="icon icon-sm rounded-circle bg-success-light">
                                <i class="text-success material-icons md-local_shipping"></i>
                            </span>
                            <div class="text">
                                <h6 class="mb-1 card-title">Total Price</h6>
                                <span><%= formatIndianCurrency(totalPrice) %></span>
                            </div>
                        </article>
                    </div>
                </div>

                <div class="col-lg-3">
                    <div class="card card-body mb-4">
                        <article class="icontext">
                            <span class="icon icon-sm rounded-circle bg-warning-light">
                                <i class="text-warning material-icons md-qr_code"></i>
                            </span>
                            <div class="text">
                                <h6 class="mb-1 card-title">Total Discounts</h6>
                                <span><%= formatIndianCurrency(totalDiscount) %></span>
                            </div>
                        </article>
                    </div>
                </div>

                <div class="col-lg-3">
                    <div class="card card-body mb-4">
                        <article class="icontext">
                            <span class="icon icon-sm rounded-circle bg-info-light">
                                <i class="text-info material-icons md-shopping_basket"></i>
                            </span>
                            <div class="text">
                                <h6 class="mb-1 card-title">Net Profit</h6>
                                <span><%= formatIndianCurrency(netProfit) %></span>
                            </div>
                        </article>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Date</th>
                                    <th>User</th>
                                    <th>Payment Method</th>
                                    <th>Payment Status</th>
                                    <th>Product Name</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Discount</th>
                                    <th>Final Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (orders && orders.length > 0) { %>
                                    <% orders.forEach((order, index) => { %>
                                        <% order.orderItems.forEach(item => { %>
                                            <tr>
                                                <td><%= index + 1 %></td>
                                                <td><%= new Date(order.createdOn).toLocaleDateString() %></td>
                                                <td><%= order.address ? `${order.address.firstName} ${order.address.lastName}` : 'N/A' %></td>
                                                <td><%= order.paymentMethod || 'N/A' %></td>
                                                <td>
                                                    <% 
                                                    let displayStatus = order.paymentStatus;
                                                    let badgeClass = 'badge-soft-secondary';
                                                    
                                                    if (order.status === 'Cancelled') {
                                                        if (order.paymentMethod === 'COD') {
                                                            displayStatus = 'Cancelled';
                                                            badgeClass = 'badge-soft-danger';
                                                        } else {
                                                            displayStatus = 'Refunded';
                                                            badgeClass = 'badge-soft-info';
                                                        }
                                                    } else if (order.status === 'Returned' || order.status === 'Return Requested') {
                                                        displayStatus = 'Refunded';
                                                        badgeClass = 'badge-soft-info';
                                                    } else if (order.paymentStatus === 'Paid') {
                                                        badgeClass = 'badge-soft-success';
                                                    } else if (order.paymentStatus === 'Pending') {
                                                        badgeClass = 'badge-soft-warning';
                                                    } else if (order.paymentStatus === 'Failed') {
                                                        badgeClass = 'badge-soft-danger';
                                                    }
                                                    %>
                                                    <span class="badge badge-pill <%= badgeClass %>"><%= displayStatus %></span>
                                                </td>
                                                <td><%= item.product ? item.product.productName : 'N/A' %></td>
                                                <td><%= item.quantity %></td>
                                                <td><%= formatIndianCurrency(item.price * item.quantity) %></td>
                                                <td><%= formatIndianCurrency(order.discount || 0) %></td>
                                                <td><%= formatIndianCurrency((item.price * item.quantity) - (order.discount || 0)) %></td>
                                            </tr>
                                        <% }); %>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="10" class="text-center">No orders found</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <script src="backend/assets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="backend/assets/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="backend/assets/js/vendors/select2.min.js"></script>
    <script src="backend/assets/js/vendors/perfect-scrollbar.js"></script>
    <script src="backend/assets/js/vendors/jquery.fullscreen.min.js"></script>
    <script src="backend/assets/js/vendors/chart.js"></script>
    <!-- Main Script -->
    <script src="backend/assets/js/main.js" type="text/javascript"></script>
    <script src="backend/assets/js/custom-chart.js" type="text/javascript"></script>
</body>

</html>